<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="/LCRSystem/image/LCRlogo.png" type="image/png" sizes="32x32">
<link rel="apple-touch-icon" href="/LCRSystem/image/LCRlogo.png">
<meta name="theme-color" content="#415D8A">
  <title>Validate Marriage</title>
  <link rel="stylesheet" href="style/styles.css">

  <style>
    :root{
      --blue-100:#D0E1F5; --blue-200:#A8BCDA; --blue-700:#415D8A;
      --white:#FFFFFF; --text:#1e293b;
      --slate-100:#f1f5f9; --slate-200:#e2e8f0; --slate-300:#cbd5e1; --slate-700:#334155;
      --green-600:#16a34a; --green-700:#15803d; --red-600:#dc2626; --red-700:#b91c1c;
      --violet-600:#7c3aed; --violet-700:#6d28d9;
    }

    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#fff;color:var(--text);}

    /* Page header */
    .page-header { margin: 24px 16px 18px; }
    .page-header h1 { font-size: 28px; margin: 0 0 4px; color: var(--text); }
    .page-header .subtitle { margin: 0; color: var(--slate-700); }

    /* Table shell */
    .table-wrap { margin: 0 16px 24px; background: var(--white); border:1px solid var(--slate-200); border-radius: 8px; overflow: hidden; }
    .reg-table { width: 100%; border-collapse: collapse; table-layout: fixed; background: var(--white); }
    .reg-table thead th {
      text-align: left; font-weight: 600; color: var(--slate-700);
      background: var(--slate-100); border-bottom: 1px solid var(--slate-200);
      padding: 12px 14px; font-size: 14px;
    }
    .reg-table td { padding: 14px; vertical-align: middle; border-top: 1px solid var(--slate-200); border-left: 1px solid var(--slate-200); }
    .reg-table td:first-child { border-left: none; }
    .reg-table tr:last-child td { border-bottom: none; }

    /* Name cell */
    .name-cell .name { font-weight: 600; color: var(--text); }
    .name-cell .muted { color: #64748b; font-size: 13px; }

    /* Link icon */
    .requirements, .link-icon { display: inline-flex; align-items: center; }
    .link-icon {
      border: 1px solid var(--slate-300);
      background: var(--white);
      padding: 8px; border-radius: 8px; cursor: pointer; color: var(--slate-700);
    }
    .link-icon:hover { background: var(--slate-100); }

    /* Buttons */
    .btn { border: 1px solid transparent; border-radius: 10px; padding: 10px 14px; font-weight: 600; cursor: pointer; font-size: 14px; display: inline-flex; align-items: center; gap: 8px; }
    .btn .btn-icon { font-weight: 700; }
    .btn.primary { background: var(--blue-700); color: #fff; }
    .btn.primary:hover { background: #3a537c; }
    .btn.success { background: var(--green-600); color: #fff; }
    .btn.success:hover { background: var(--green-700); }
    .btn.success.outline { background: #eaf7ef; color: var(--green-700); border-color: #b7e0c3; }
    .btn.danger { background: var(--red-600); color: #fff; }
    .btn.danger.ghost { background: #fff; color: var(--red-700); border-color: #fecaca; }
    .btn.sm { padding: 6px 10px; font-size: 13px; border-radius: 8px; }

    /* Inline actions */
    .actions-inline { display: inline-flex; gap: 8px; }

    /* Stack */
    .stack-gap-6 { display: grid; gap: 6px; }

    /* Badges */
    .badge { display:inline-flex; align-items:center; padding: 4px 8px; border-radius: 999px; font-size: 12px; font-weight: 600; }
    .badge.ok { background: #e8f5ee; color: var(--green-700); border: 1px solid #b7e0c3; }
    .badge.pending { background: #f1f5ff; color: #1e40af; border: 1px solid #c7d2fe; }
    .badge.reject { background: #fff1f2; color: var(--red-700); border: 1px solid #fecdd3; }

    /* Actions column links */
    .action-links { display: grid; gap: 8px; }
    .action { display:inline-flex; align-items:center; gap: 6px; text-decoration: none; font-weight: 600; color: var(--blue-700); }
    .action .action-icon { font-size: 14px; }
    .action:hover { text-decoration: underline; }
    .action.violet { color: var(--violet-700); }

    /* Dialogs (requirements & validate registration) */
    .req-dialog {
      width: 900px; max-width: 95vw;
      margin: auto; padding: 0;
      border: 1px solid var(--slate-300);
      border-radius: 12px;
    }
    .req-dialog::backdrop { background: rgba(0,0,0,.35); }

    .req-dialog header{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 14px; background:var(--slate-100); border-bottom:1px solid var(--slate-200);
    }
    .req-dialog h3{ margin:0; font-size:16px; color:var(--text); }
    .icon.ghost { background: transparent; border: none; font-size: 16px; cursor: pointer; color: var(--slate-700); }
    .icon.ghost:hover { opacity: .8; }

    /* Table-like content inside dialogs */
    .req-table{ width:100%; border:1px solid var(--slate-200); border-radius:10px; overflow:hidden; }
    .req-thead{ display:grid; grid-template-columns:1.4fr 1fr 1.4fr; background:var(--slate-100); }
    .req-th{ padding:10px 12px; font-weight:700; color:var(--slate-700); border-right:1px solid var(--slate-200); text-align:center; }
    .req-th:last-child{ border-right:none; }
    .req-tbody{ list-style:none; margin:0; padding:0; }
    .req-tr{ display:grid; grid-template-columns:1.4fr 1fr 1.4fr; }
    .req-td{
      padding:12px; background:#fff;
      border-top:1px solid var(--slate-200); border-right:1px solid var(--slate-200);
    }
    .req-td:last-child{ border-right:none; }
    .req-title{ font-weight:600; color:var(--text); display:flex; align-items:center; }
    .req-td .actions-inline{ display:inline-flex; gap:10px; justify-content:center; width:100%; }
    .note-form{ display:grid; gap:8px; justify-items:center; }
    .note-input{ width:100%; border:1px solid var(--slate-300); border-radius:8px; padding:8px 10px; font:inherit; resize:vertical; }
    .req-td:has(.note-form[hidden]){ background:#fff; }

    /* Big modal for the registration form */
    .form-dialog {
      width: 95vw; max-width: 1200px;
      height: 92vh; max-height: 92vh;
      margin: auto; padding: 0;
      border: 1px solid var(--slate-300);
      border-radius: 12px;
    }
    .form-dialog::backdrop { background: rgba(0,0,0,.45); }
    .form-dialog__bar{
      display:flex; align-items:center; justify-content:space-between;
      gap: 12px; padding: 10px 12px; background: var(--slate-100); border-bottom: 1px solid var(--slate-200);
    }
    .form-dialog__bar h3{ margin:0; font-size:16px; color:var(--text); }
    .form-dialog__actions{ display:flex; gap:8px; }
    .form-dialog__host{ width: 100%; height: calc(92vh - 50px); background:#fff; }
    .form-dialog__host iframe{ width: 100%; height: 100%; border: 0; background: #fff; }

    /* 2-column app layout so content sits beside the sidebar */
    .app{
      display: grid;
      grid-template-columns: 260px 1fr;
      min-height: 100dvh;
    }
    .content{ padding: 16px 16px 24px; }
    .sidebar{ width: 260px; }

    /* optional: scale down on small screens */
    @media (max-width:1024px){
      .page-header .page-title{ font-size:56px; }
      .page-header .subtitle{ font-size:32px; }
    }
    @media (max-width:640px){
      .page-header .page-title{ font-size:40px; }
      .page-header .subtitle{ font-size:22px; }
    }

    /* huge header + subheader */
    .page-header .page-title{
      font-size: 58px;
      line-height: 1.05;
      font-weight: 800;
      margin: 0;
      color: var(--text);
    }
    .page-header .subtitle{
      font-size: 28px;
      line-height: 1.1;
      font-weight: 600;
      margin: 6px 0 0;
      color: var(--slate-700);
    }

    .typewriter{
      display: inline-block;
      white-space: nowrap;
      overflow: hidden;
      border-right: 2px solid transparent;  /* caret */
      padding-right: .1em;
      --tw-chars: 0;
      --tw-duration: 3s;
    }
    .typewriter.animating{
      border-right-color: #415D8A;   /* caret color */
      animation: typing var(--tw-duration) steps(var(--tw-chars), end) forwards;
    }
    @keyframes typing{
      from{ width: 0 }
      to  { width: calc(var(--tw-chars) * 1ch) }
    }

    /* ‚Äî‚Äî‚Äî Search toolbar (right-aligned) ‚Äî‚Äî‚Äî */
    .val-toolbar{
      display:flex; justify-content:flex-end; align-items:center;
      gap:.6rem; margin:.35rem 16px .6rem; /* align with page margins */
    }
    .val-search{ position:relative; width:min(360px, 100%); }
    .val-search input{
      width:100%; height:2.2rem; padding:.45rem 2.2rem .45rem .65rem;
      border:1px solid var(--slate-300); border-radius:8px; outline:none;
      font:inherit;
    }
    .val-search svg{
      position:absolute; right:.5rem; top:50%; transform:translateY(-50%);
      width:18px; height:18px; opacity:.7; pointer-events:none;
    }
    @media print{ .val-toolbar{ display:none; } }
  </style>
</head>

<body>

<div class="app">
  <aside class="sidebar" data-collapsed="false">
    <div class="brand">
      <div class="logo">
        <img src="image/LCRlogo.png" alt="LCR Logo">
      </div>
      <div class="name">
        Shields<span class="accent">.Civil</span>
      </div>
      <p class="tagline">Civil Registry Management System</p>
    </div>

    <nav class="nav" role="navigation">
      <div class="nav__section">Main</div>
      <a href="staffPanel.html" class="nav__link " aria-current="page" title="Home">
        <span class="nav__icon" aria-hidden="true">üè†</span>
        <span class="nav__label">Home</span>
      </a>
      <a href="validateDashboard.html" class="nav__link " title="Dashboard">
        <span class="nav__icon" aria-hidden="true">üìä</span>
        <span class="nav__label">Dashboard</span>
      </a>

      <div class="nav__section">Validations</div>
      <a href="validateBirth.html" class="nav__link" title="Validate Birth">
        <span class="nav__icon" aria-hidden="true">üë∂</span>
        <span class="nav__label">Validate Birth</span>
      </a>
      <a href="validateDeath.html" class="nav__link" title="Validate Death">
        <span class="nav__icon" aria-hidden="true">üïäÔ∏è</span>
        <span class="nav__label">Validate Death</span>
      </a>
      <a href="validateMarriage.html" class="nav__link is-active" title="Validate Marriage">
        <span class="nav__icon" aria-hidden="true">üíç</span>
        <span class="nav__label">Validate Marriage</span>
      </a>
    </nav>
  </aside>

  <main class="content">
    <section class="page-header">
      <h1 class="page-title">
        <span class="typewriter">Marriage Registration Validation</span>
      </h1>
      <p class="subtitle">Review and validate registration applications</p>

      <br><br><br><br>

      <!-- ===== Search toolbar (right aligned) ===== -->
      <div class="val-toolbar">
        <label class="val-search" aria-label="Search registrations">
          <input id="val-search" type="search" placeholder="Search" />
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16a6.471 6.471 0 0 0 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"></path>
          </svg>
        </label>
      </div>

      <div class="table-wrap">
        <table class="reg-table">
          <colgroup>
            <col style="width: 18%">
            <col style="width: 22%">
            <col style="width: 12%">
            <col style="width: 20%">
            <col style="width: 13%">
            <col style="width: 15%">
          </colgroup>
          <thead>
            <tr>
              <th>Name</th>
              <th>Validate Requirements</th>
              <th>Status</th>
              <th>Validate Registration</th>
              <th>Final Status</th>
              <th>Actions</th>
            </tr>
          </thead>

          <!-- BODY now has an ID for filtering -->
          <tbody id="val-body">
            <tr>
              <!-- NAME -->
              <td>
                <div class="name-cell">
                  <div class="name">Jouselo Nakila</div>
                  <div class="muted">john.smith@email.com</div>
                  <div class="muted">Engineering</div>
                </div>
              </td>

              <!-- VALIDATE REQUIREMENTS -->
              <td>
                <div class="requirements">
                  <button class="link-icon" data-open="req-1" aria-label="View requirements">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                      <path d="M10.59 13.41a2 2 0 0 0 2.82 0l3.59-3.59a2 2 0 1 0-2.82-2.82l-1.18 1.18" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M13.41 10.59a2 2 0 0 0-2.82 0L7 14.18a2 2 0 1 0 2.82 2.82l1.18-1.18" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </button>

                  <!-- Requirements dialog -->
                  <dialog id="req-1" class="req-dialog">
                    <header>
                      <h3>Uploaded Requirements</h3>
                      <button class="icon ghost" data-close aria-label="Close">‚úï</button>
                    </header>

                    <div class="req-table">
                      <div class="req-thead">
                        <div class="req-th">Requirement</div>
                        <div class="req-th">Actions</div>
                        <div class="req-th">Notes</div>
                      </div>

                      <ul class="req-tbody">
                        <li class="req-tr">
                          <span class="req-td req-title">Birth Certificate (PDF)</span>
                          <div class="req-td">
                            <div class="actions-inline">
                              <button class="btn sm success" data-approve>Approve</button>
                              <button class="btn sm danger ghost" data-revise>Revise (with note)</button>
                            </div>
                          </div>
                          <div class="req-td">
                            <form class="note-form" hidden>
                              <textarea class="note-input" rows="3" placeholder="Add a short note explaining what to revise..."></textarea>
                              <button class="btn sm primary" data-send-revision>Send for Revision</button>
                            </form>
                          </div>
                        </li>

                        <li class="req-tr">
                          <span class="req-td req-title">Parent ID (Front)</span>
                          <div class="req-td">
                            <div class="actions-inline">
                              <button class="btn sm success" data-approve>Approve</button>
                              <button class="btn sm danger ghost" data-revise>Revise (with note)</button>
                            </div>
                          </div>
                          <div class="req-td">
                            <form class="note-form" hidden>
                              <textarea class="note-input" rows="3" placeholder="Add a short note explaining what to revise..."></textarea>
                              <button class="btn sm primary" data-send-revision>Send for Revision</button>
                            </form>
                          </div>
                        </li>

                        <li class="req-tr">
                          <span class="req-td req-title">Parent ID (Back)</span>
                          <div class="req-td">
                            <div class="actions-inline">
                              <button class="btn sm success" data-approve>Approve</button>
                              <button class="btn sm danger ghost" data-revise>Revise (with note)</button>
                            </div>
                          </div>
                          <div class="req-td">
                            <form class="note-form" hidden>
                              <textarea class="note-input" rows="3" placeholder="Add a short note explaining what to revise..."></textarea>
                              <button class="btn sm primary" data-send-revision>Send for Revision</button>
                            </form>
                          </div>
                        </li>

                        <li class="req-tr">
                          <span class="req-td req-title">Hospital Record</span>
                          <div class="req-td">
                            <div class="actions-inline">
                              <button class="btn sm success" data-approve>Approve</button>
                              <button class="btn sm danger ghost" data-revise>Revise (with note)</button>
                            </div>
                          </div>
                          <div class="req-td">
                            <form class="note-form" hidden>
                              <textarea class="note-input" rows="3" placeholder="Add a short note explaining what to revise..."></textarea>
                              <button class="btn sm primary" data-send-revision>Send for Revision</button>
                            </form>
                          </div>
                        </li>
                      </ul>
                    </div>
                  </dialog>
                </div>
              </td>

              <!-- STATUS -->
              <td>
                <div class="stack-gap-6" data-status>
                  <span class="badge pending">Pending</span>
                </div>
              </td>

              <!-- VALIDATE REGISTRATION (same UI as requirements) -->
              <td>
                <div class="validate-registration">
                  <button class="link-icon" data-open="reg-1" aria-label="View registration details">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                      <path d="M10.59 13.41a2 2 0 0 0 2.82 0l3.59-3.59a2 2 0 1 0-2.82-2.82l-1.18 1.18" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M13.41 10.59a2 2 0 0 0-2.82 0L7 14.18a2 2 0 1 0 2.82 2.82l1.18-1.18" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </button>
                </div>

                <dialog id="reg-1" class="req-dialog">
                  <header>
                    <h3>Validate Registration</h3>
                    <button class="icon ghost" data-close aria-label="Close">‚úï</button>
                  </header>

                  <div class="req-table">
                    <div class="req-thead">
                      <div class="req-th">Field</div>
                      <div class="req-th">Actions</div>
                      <div class="req-th">Notes</div>
                    </div>

                    <ul class="req-tbody">
                      <li class="req-tr">
                        <span class="req-td req-title">Full Name: John Smith</span>
                        <div class="req-td">
                          <div class="actions-inline">
                            <button class="btn sm success" data-approve>Approve</button>
                            <button class="btn sm danger ghost" data-revise>Revise (with note)</button>
                          </div>
                        </div>
                        <div class="req-td">
                          <form class="note-form" hidden>
                            <textarea class="note-input" rows="3" placeholder="Add note for revision..."></textarea>
                            <button class="btn sm primary" data-send-revision>Send for Revision</button>
                          </form>
                        </div>
                      </li>

                      <li class="req-tr">
                        <span class="req-td req-title">Date of Birth: 12/03/2023</span>
                        <div class="req-td">
                          <div class="actions-inline">
                            <button class="btn sm success" data-approve>Approve</button>
                            <button class="btn sm danger ghost" data-revise>Revise (with note)</button>
                          </div>
                        </div>
                        <div class="req-td">
                          <form class="note-form" hidden>
                            <textarea class="note-input" rows="3" placeholder="Add note for revision..."></textarea>
                            <button class="btn sm primary" data-send-revision>Send for Revision</button>
                          </form>
                        </div>
                      </li>

                      <li class="req-tr">
                        <span class="req-td req-title">Place of Birth: General Hospital</span>
                        <div class="req-td">
                          <div class="actions-inline">
                            <button class="btn sm success" data-approve>Approve</button>
                            <button class="btn sm danger ghost" data-revise>Revise (with note)</button>
                          </div>
                        </div>
                        <div class="req-td">
                          <form class="note-form" hidden>
                            <textarea class="note-input" rows="3" placeholder="Add note for revision..."></textarea>
                            <button class="btn sm primary" data-send-revision>Send for Revision</button>
                          </form>
                        </div>
                      </li>
                    </ul>
                  </div>
                </dialog>
              </td>

              <!-- FINAL STATUS -->
              <td>
                <div class="stack-gap-6" data-status-final>
                  <span class="badge pending">Pending</span>
                </div>
              </td>

              <!-- VIEW FORM (opens big modal with iframe) -->
              <td>
                <div class="action-links">
                  <a href="#" class="action violet" data-open-form="form-1">
                    <span class="action-icon">üìù</span> View Registration Form
                  </a>
                </div>
              </td>
            </tr>
          </tbody>

          <!-- Empty state body (shown when search has no matches) -->
          <tbody id="val-empty" style="display:none">
            <tr>
              <td colspan="6" style="padding:12px 14px;color:#64748b">No matching registrations.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>
</div>

<!-- Registration Form Modal -->
<dialog id="form-1" class="form-dialog">
  <header class="form-dialog__bar">
    <h3>Registration Form ‚Äì Certificate of Live Birth</h3>
    <div class="form-dialog__actions">
      <button class="btn sm primary" data-print>Print</button>
      <button class="btn sm danger ghost" data-close aria-label="Close">Close ‚úï</button>
    </div>
  </header>
  <div class="form-dialog__host">
    <iframe id="regFormFrame-1"
            title="Certificate of Live Birth"
            sandbox="allow-same-origin allow-forms allow-scripts allow-popups allow-modals"></iframe>
  </div>
</dialog>

<!-- ===== The full birth form HTML is stored in this template and injected into the iframe ===== -->
<template id="birth-form-template">
  <!-- (template content unchanged; omitted here for brevity in this message if you already have it)
       If you need the full inner HTML again, keep what you pasted previously. -->
</template>

<script>
  /* ===========================
     Dialog open/close handlers
     =========================== */
  document.addEventListener('click', (e) => {
    const openBtn = e.target.closest('[data-open]');
    if (openBtn) {
      const id = openBtn.getAttribute('data-open');
      const dlg = document.getElementById(id);
      if (dlg && typeof dlg.showModal === 'function') dlg.showModal();
    }
    if (e.target.matches('[data-close]')) {
      const dlg = e.target.closest('dialog');
      if (dlg) dlg.close();
    }
  });

  /* =======================================
     Approve / Revise (with note) per item
     ======================================= */
  document.addEventListener('click', (e) => {
    // Approve
    const approveBtn = e.target.closest('[data-approve]');
    if (approveBtn) {
      approveBtn.textContent = 'Approved';
      approveBtn.disabled = true;
      const actionsRow = approveBtn.closest('.actions-inline');
      const reviseBtn = actionsRow?.querySelector('[data-revise]');
      if (reviseBtn) reviseBtn.disabled = true;
      return;
    }

    // Show note form
    const reviseBtn = e.target.closest('[data-revise]');
    if (reviseBtn) {
      const li = reviseBtn.closest('li, .req-tr');
      const form = li.querySelector('.note-form');
      if (form) { form.hidden = false; reviseBtn.disabled = true; }
      return;
    }

    // Send revision
    const sendBtn = e.target.closest('[data-send-revision]');
    if (sendBtn) {
      e.preventDefault();
      const form = sendBtn.closest('.note-form');
      const textarea = form.querySelector('.note-input');
      const note = textarea.value.trim();
      if (!note) { textarea.focus(); textarea.placeholder = 'Please add a short note before sending‚Ä¶'; return; }
      sendBtn.textContent = 'Revision Sent';
      sendBtn.disabled = true;
      const li = sendBtn.closest('li, .req-tr');
      li.querySelectorAll('[data-approve],[data-revise]').forEach(b => b.disabled = true);
      return;
    }
  });

  /* =======================================
     Auto-update row Status from dialog state
     ======================================= */
  function makeBadge(type, text) {
    const span = document.createElement('span');
    span.className = 'badge';
    if (type === 'ok') span.classList.add('ok');
    if (type === 'pending') span.classList.add('pending');
    if (type === 'reject') span.classList.add('reject');
    span.textContent = text;
    return span;
  }
  function renderStatus(container, type, text) {
    if (!container) return;
    container.innerHTML = '';
    container.appendChild(makeBadge(type, text));
  }
  function computeDialogStatus(dlg) {
    const items = dlg.querySelectorAll('.req-tr, li');
    let approved = 0, revised = 0, total = 0;
    items.forEach(item => {
      total++;
      const approveBtn = item.querySelector('[data-approve]');
      const reviseBtn  = item.querySelector('[data-revise]');
      const sendBtn    = item.querySelector('[data-send-revision]');
      const noteForm   = item.querySelector('.note-form');
      const isApproved = !!(approveBtn?.disabled && /approved/i.test(approveBtn.textContent));
      const sentRevision = !!(sendBtn?.disabled && /revision sent/i.test(sendBtn.textContent));
      const requestedRevision = !!(reviseBtn?.disabled && noteForm && !noteForm.hidden);
      if (isApproved) approved++; else if (sentRevision || requestedRevision) revised++;
    });
    return { total, approved, revised };
  }
  function findRowForDialog(dlg) {
    const opener = document.querySelector(`[data-open="${dlg.id}"]`);
    return opener ? opener.closest('tr') : null;
  }
  function updateStatusFromDialog(dlg) {
    const row = findRowForDialog(dlg);
    if (!row) return;
    const { total, approved, revised } = computeDialogStatus(dlg);
    let type = 'pending', text = 'Pending';
    if (total > 0 && approved === total) { type = 'ok'; text = 'Approved'; }
    else if (revised > 0) { type = 'reject'; text = 'Revision Required'; }
    const statusDiv = row.querySelector('[data-status]');
    renderStatus(statusDiv, type, text);
    // Optional: mirror to Final Status
    const finalDiv = row.querySelector('[data-status-final]');
    if (finalDiv) renderStatus(finalDiv, type, text);
  }
  document.addEventListener('click', (e) => {
    if (
      e.target.closest('[data-approve]') ||
      e.target.closest('[data-revise]') ||
      e.target.closest('[data-send-revision]')
    ) {
      const dlg = e.target.closest('dialog');
      if (dlg) setTimeout(() => updateStatusFromDialog(dlg), 50);
    }
  });
  document.addEventListener('close', (e) => {
    if (e.target instanceof HTMLDialogElement) updateStatusFromDialog(e.target);
  }, true);

  /* =======================================
     View Registration Form (iframe loader)
     ======================================= */
  function getTemplateHTML(tpl) {
    let html = (tpl.innerHTML || "").trim();
    if (!html && tpl.content) {
      html = new XMLSerializer().serializeToString(tpl.content.cloneNode(true));
    }
    return html;
  }
  function injectIntoIframe(frame, html) {
    frame.srcdoc = html;
    const onLoad = () => {
      try {
        const doc = frame.contentDocument || frame.contentWindow?.document;
        const isBlank = !doc || !doc.body || !doc.body.childElementCount;
        if (isBlank) { doc.open(); doc.write(html); doc.close(); }
      } catch (e) {
        console.warn('Iframe fallback write failed:', e);
      } finally {
        frame.removeEventListener('load', onLoad);
      }
    };
    frame.addEventListener('load', onLoad);
  }
  document.addEventListener('click', (e) => {
    const trigger = e.target.closest('[data-open-form]');
    if (trigger) {
      e.preventDefault();
      const dlg = document.getElementById(trigger.getAttribute('data-open-form'));
      const frame = dlg?.querySelector('iframe');
      const tpl  = document.getElementById('birth-form-template');
      if (frame && tpl) {
        const html = getTemplateHTML(tpl);
        injectIntoIframe(frame, html);
      }
      dlg?.showModal();
    }
    if (e.target.matches('[data-close]')) {
      e.target.closest('dialog')?.close();
    }
    if (e.target.matches('[data-print]')) {
      const frame = e.target.closest('dialog')?.querySelector('iframe');
      frame?.contentWindow?.focus();
      frame?.contentWindow?.print();
    }
  });

  // Typewriter init
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.typewriter').forEach(el => {
      const text = el.textContent.trim();
      el.style.setProperty('--tw-chars', text.length);
      el.style.setProperty('--tw-duration', Math.max(1.8, text.length * 0.065) + 's');
      el.classList.add('animating');
      el.addEventListener('animationend', (e) => {
        if (e.animationName === 'typing') el.style.borderRight = 'none';
      });
    });
  });

  /* ===========================
     Live search filter (NEW)
     =========================== */
  (function(){
    const tbody = document.getElementById('val-body');
    const empty = document.getElementById('val-empty');
    const search = document.getElementById('val-search');
    if(!tbody || !empty || !search) return;

    function runFilter(){
      const q = (search.value || '').trim().toLowerCase();
      let shown = 0;
      [...tbody.querySelectorAll('tr')].forEach(tr=>{
        // Collect searchable content: name + muted lines + maybe actions labels
        const hay = tr.textContent.toLowerCase();
        const match = hay.includes(q);
        tr.style.display = match ? '' : 'none';
        if(match) shown++;
      });
      empty.style.display = shown === 0 ? '' : 'none';
    }
    search.addEventListener('input', runFilter);
    runFilter();
  })();
</script>

<footer class="footer">
  <p>¬© 2025 Shields.Civil Registry Management | Ensuring accuracy and integrity of records</p>
</footer>
</body>
</html>
